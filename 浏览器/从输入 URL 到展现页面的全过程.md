# 从输入 URL 到展现页面的全过程
> [MDN 渲染页面：浏览器的工作原理](https://developer.mozilla.org/zh-CN/docs/Web/Performance/How_browsers_work)
> 图解HTTP
> 

[TOC]


## 1. DNS解析
* DNS是位于应用层的协议，用于查找主机名对应的IP地址。
* 浏览器通过域名地址（服务器名称）请求DNS查找，最终返回一个IP地址。
* 第一次初始化后，这个IP地址可能会被缓存一段时间，这样就可以从缓存中检索IP地址，而不是再通过域名服务器进行查找。缓存IP地址有助于加速后续请求，缩短页面显示完成的时间。
* 针对不同的主机名，DNS要进行多次查找。
* DNS查找对性能有影响，尤其是移动网络。
	* 每个DNS查找必须从手机发送到信号塔，信号塔再发送到认证DNS服务器。这三者之间的距离可能是一个的时间等待。 	

<!-- 是否还需要从网络的角度再细化讲解 -->


## 2. TCP连接
* 获取到IP地址后，客户端向服务器端发起TCP连接请求。通过3次握手建立TCP连接.
* TCP是传输层协议，为了方便通信，将HTTP请求报文按序号分成多个报文段，把每个报文段科考的传给对方。


> 如果是HTTPS协议，那么在建立TCP连接之后，会开启SSL协商过程，协商成功后，客户端才能发送请求。
## 3. 客户端发送HTTP请求

HTTP 协议是建立在 TCP 协议之上的应用层协议，其本质是在建立起的TCP连接中，按照HTTP协议标准发送一个索要网页的请求。在这一过程中，会涉及到负载均衡等操作。

## 4. 服务器端处理请求并返回
服务器获取到客户端的 HTTP 请求后，会根据 HTTP 请求中的内容来决定如何获取相应的文件，并将文件发送给浏览器。

## 5. 浏览器

浏览器会先解析接收到的数据，生成DOM树、CSSOM树，在解析时还会编译JavaScript和生成AOM树。
然后将解析的结果渲染到页面上显示出来。

* 在解析 HTML 时会创建文档对象模型。
	* HTML 可以请求 JavaScript，而 JavaScript  反过来，又可以更改 DOM。
* HTML 包含或请求样式，依次来构建 CSS 对象模型。
* 浏览器引擎将两者结合起来以创建渲染树。
* 布局确定页面上所有内容的大小和位置。
* 确定布局后，将像素绘制到屏幕上。


### 解析
当浏览器接收到初始14kb数据之后就开始解析了。（所以这14kb数据中最好包含浏览器开始渲染页面的所有内容）

#### 第一步：处理HTML标记并构造DOM树

* 解析器遇到图片或CSS文件时，解析依然可以继续。
	* 但CSS文件没有加载完成会阻碍CSSOM的构建，从而阻塞渲染。
	* 而如果没有明确设定img的宽高，在绘制之后加载完img，会造成重排。
* 遇到没有async或defer属性设置的 <script>标签会阻塞渲染并停止HTML解析。

* 当主线程在解析HTML和CSS时，预加载扫描器将找到脚本和图像，并开始下载它们
	* 等待获取CSS不会阻塞HTML的解析或者下载，但是它的确阻塞JavaScript，因为JavaScript经常用于查询元素的CSS属性。


#### 第二步：处理CSS并构建CSSOM树

* 浏览器将接收到的CSS规则转换为可以使用的内容。根据CSS选择器，创建具有父、子和兄弟关系的节点树。
* CSS 是渲染阻塞的：浏览器会阻塞页面渲染直到它接收和执行了所有的 CSS
	* CSS 是渲染阻塞是因为规则可以被覆盖，所以内容不能被渲染直到 CSSOM 的完成。

* 构建CSSOM非常非常快，创建CSSOM的总时间通常小于一次DNS查找所需的时间


#### 其他过程
##### JavaScript 编译

##### 构建辅助功能树 AOM

### 渲染

#### 第三步：结合DOM和CSSOM生成Render树。
Render树上的每个节点都是具有样式和内容的可见节点。

具有display: none样式的DOM节点，不在Render树上。

#### 第四步：布局（Layout）
布局是确定Render树中每个节点的宽度、高度和位置，以及确定页面上每个对象的大小和位置的过程。
布局取决于屏幕的尺寸。布局这个步骤决定了在哪里和如何在页面上放置元素，决定了每个元素的宽和高，以及他们之间的相关性。

第一次确定节点的大小和位置称为布局(Layout)。随后对节点大小和位置的重新计算称为回流(重排)
假设初始布局发生在返回图像之前。由于我们没有声明图像的大小，因此一旦知道图像大小，就会有回流。

#### 第五步：绘制（Paint）

将各个确定了大小和位置的节点绘制到屏幕上。




## 6. 断开连接

客户端通过4次挥手终止TCP连接



--------

## 优化页面渲染性能
目标：

* 加载页面快，无明显白屏现象
	* 如果无法避免白屏，可以使用骨架屏显示。或者友好提示。减少用户焦虑感。 
* 快速响应用户交互，不卡顿

优化：

* 减少DNS解析时间。
	* DNS 预获取 
* 使用SSL通信专用硬件提高SSL计算速度。
* 使用rel="preconnect" 对使用HTTPS的跨域地址进行预连接，减少请求时间。
* web性能优化需要将初始14kb响应作为重点。这14kb内容包含首次渲染的所需的所有内容，将不需要的资源进行懒加载。
* 不要在HTML文档中使用过多的<script>标签去加载JS文件或代码。
	* 可以将<script>标签写在</body> 标签后面，避免阻塞页面渲染
	* 可以使用新属性 async 或 defer 来避免阻塞HTML标签的解析
* 为了优化CSSOM的构造，请删除不必要的样式，对 CSS 进行最小化，压缩和缓存，并将页面加载时不需要的CSS拆分为其他文件，以减少CSS渲染阻塞。
* 减少重排(回流)和重绘。


优化关键渲染路径可以**缩短首次渲染的时间**

